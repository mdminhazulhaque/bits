<!DOCTYPE html> <html lang="en-us"> <head> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta http-equiv="content-type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"> <meta name="theme-color" content="#000000"> <meta name="msapplication-navbutton-color" content="#000000"> <meta name="apple-mobile-web-app-status-bar-style" content="#000000"> <meta name="description" content="uhttpd is a lightweight HTTP web server that supports running Lua scripts as CGI. It is possible to create custom REST API or any other callback using Lu..."> <meta name="author" content="Md. Minhazul Haque"> <script type="application/ld+json">{ "@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [ { "@type": "ListItem", "position": 1, "name": "Bits", "item": "https://bits.mdminhazulhaque.io/" },{ "@type": "ListItem", "position": 2, "name": "openwrt", "item": "https://bits.mdminhazulhaque.io/openwrt" },{ "@type": "ListItem", "position": 3, "name": "Run Custom Lua Script as CGI with uhttpd", "item": "https://bits.mdminhazulhaque.io//openwrt/run-custom-lua-script-as-cgi-with-uhttpd.html" }] }</script> <title>Run Custom Lua Script as CGI with uhttpd | Bits</title> <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet"> <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> <link rel="stylesheet" href="/public/css/poole.css"> <link rel="stylesheet" href="/public/css/hyde.css"> <link rel="stylesheet" href="/public/css/print.css"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon.png"> <link rel="icon" type="image/x-icon" href="/public/favicon.ico?v=1"> <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml"> <style>.blink{animation:blink 1s infinite;}@keyframes blink{to{opacity:.0}}</style> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> </head> <body> <div class="sidebar"> <div class="container sidebar-sticky"> <div class="sidebar-about"> <h1> <a class="monospace" href="/"> Bits<span class="blink">_</span> </a> </h1> <p class="lead">Random posts written by <a href="https://mdminhazulhaque.io">Minhaz</a></p> <p>Find me at ... <br><a href="https://github.com/mdminhazulhaque"><i class="fa fa-fw fa-github"></i> Github</a> <br><a href="https://bd.linkedin.com/in/mdminhazulhaque"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a> </p> </div> <p>&copy; 2012 - 2021. All rights reserved.</p> </div> </div> <div class="content container"> <div class="post"> <h1 class="post-title">Run Custom Lua Script as CGI with uhttpd</h1> <hr> <i class="fa fa-fw fa-calendar"></i>26 Nov 2016 <i class="fa fa-fw fa-tag"></i><a href="/openwrt">openwrt</a> <hr> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9642838276352812" data-ad-slot="2958174403" data-ad-format="auto" data-full-width-responsive="true"></ins> <script>(adsbygoogle = window.adsbygoogle || []).push({});</script> <br> <p>uhttpd is a lightweight HTTP web server that supports running Lua scripts as CGI. It is possible to create custom REST API or any other callback using Lua functionality of uhttpd. All you need to do is to put a script somewhere in your filesystem that has one <code class="language-plaintext highlighter-rouge">handle_request</code> function, and tweak some UCI configs. Let me tell you more.</p> <p>First, let’s install Lua support for uhttpd.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg <span class="nb">install </span>uhttpd-mod-lua
</code></pre></div></div> <p>Then let’s change UCI entries for uhttpd.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uci <span class="nb">set </span>uhttpd.main.lua_prefix<span class="o">=</span><span class="s1">'/lua'</span>
uci <span class="nb">set </span>uhttpd.main.lua_handler<span class="o">=</span><span class="s1">'/root/index.lua'</span>
uci commit uhttpd
</code></pre></div></div> <p>As you can see, we have set a new URI endpoint at <code class="language-plaintext highlighter-rouge">/lua</code> and the path will be routed to the Lua file at <code class="language-plaintext highlighter-rouge">/root/index.lua</code>. So let’s put the following lines inside that file.</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">pr</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"luci.http.protocol"</span>
<span class="c1">-- since openwrt 19 try this</span>
<span class="c1">-- local pr = require "luci.http"</span>

<span class="k">function</span> <span class="nf">handle_request</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">uhttpd</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"Status: 200 OK\r\n"</span><span class="p">)</span>
    <span class="n">uhttpd</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s2">"Content-Type: text/html\r\n\r\n"</span><span class="p">)</span>
    
    <span class="c1">-- strip "/lua/" from the begining</span>
    <span class="kd">local</span> <span class="n">command</span> <span class="o">=</span> <span class="n">pr</span><span class="p">.</span><span class="n">urldecode</span><span class="p">(</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">REQUEST_URI</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    
    <span class="kd">local</span> <span class="n">proc</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="nb">io.popen</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">line</span> <span class="k">in</span> <span class="n">proc</span><span class="p">:</span><span class="n">lines</span><span class="p">()</span> <span class="k">do</span>
        <span class="n">uhttpd</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="o">..</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">proc</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="k">end</span>
</code></pre></div></div> <p>You might already have guessed that this simple Lua script will execute any shell command that comes in the form of URI (encoded) and pass the stdout buffer as HTTP content. Now we have to restart uhttpd to detect the changes.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/uhttpd restart
</code></pre></div></div> <p>Now it’s time to do some real check. Let’s run the command <code class="language-plaintext highlighter-rouge">uptime</code>. I did run the following.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minhaz:~ <span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s1">'http://192.168.1.1/lua/uptime'</span>
17:35:14 up 28 day,  6:30,  1 <span class="nb">users</span>,  load average: 0.97, 0.92, 0.90
</code></pre></div></div> <p>It works! Just remember that, you have to pass the URI string as urlencoded.</p> <p>Go play with it a bit more until your router gets bricked. Good luck! :)</p> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9642838276352812" data-ad-slot="7351100586" data-ad-format="auto" data-full-width-responsive="true"></ins> <script>(adsbygoogle = window.adsbygoogle || []).push({});</script> <div id="disqus_thread"></div> <script type="text/javascript"> (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'https://bitsfromminhaz.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </body> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-57632461-7', 'auto'); ga('send', 'pageview'); </script> </html>
